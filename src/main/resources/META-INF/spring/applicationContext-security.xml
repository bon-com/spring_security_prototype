<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:sec="http://www.springframework.org/schema/security"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           https://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/context
           https://www.springframework.org/schema/context/spring-context.xsd
           http://www.springframework.org/schema/security
           https://www.springframework.org/schema/security/spring-security.xsd">

	<!-- 静的リソース（CSS, JS, 画像など）へのセキュリティ除外 -->
	<sec:http pattern="/resources/**" security="none" />
	<!-- 認証クラス -->
	<bean id="userDetailsService" class="com.example.prototype.biz.users.service.AuthenticationUserService" />
	<!-- 認証時のパスワードエンコーダー -->
	<bean id="passwordEncoder" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder" />
	<!-- 認可エラー時のハンドリングクラス -->
	<bean id="accessDeniedHandler" class="com.example.prototype.biz.users.listener.ExtendedAccessDeniedHandler" />
	<!-- 同一ユーザーの同時ログイン数を制限するためのクラス -->
	<bean id="sessionRegistry" class="org.springframework.security.core.session.SessionRegistryImpl" />
	
	<!-- 認証と認可の設定をここに記載していく -->
	<sec:http>
		<!-- user配下は利用者、マネジャー、管理者、開発者ロールを許可 -->
		<sec:intercept-url pattern="/user/**" access="hasAnyRole('ROLE_USER','ROLE_ADMIN','ROLE_DEVELOPER')" />
		<!-- admin配下は管理者、開発者ロールを許可 -->
		<sec:intercept-url pattern="/admin/**" access="hasAnyRole('ROLE_ADMIN','ROLE_DEVELOPER')" />
		<sec:intercept-url pattern="/oauth2/**" access="permitAll" />
		<!-- 自作したログイン画面のパス「/login」は認証不要とする（※isAuthenticated()の設定よりも先に定義すること） -->
		<sec:intercept-url pattern="/login" access="permitAll()" />
		<!-- 無効なセッションでアクセスした際のエラー画面リダイレクトURLは認証不要とする -->
		<sec:intercept-url pattern="/session-invalid" access="permitAll()" />
		<!-- すべてのパスで認証が必要 -->
		<sec:intercept-url pattern="/**" access="isAuthenticated()" />
		<!--
		これがないとOAuth2のフィルターが登録されずGoogle認証画面が404になってしまう事象があった
		-->
	    <sec:oauth2-login 
	       client-registration-repository-ref="clientRegistrationRepository"
		   authorized-client-service-ref="authorizedClientService"
	       login-page="/login" />
		<!-- 
		未認証時のパス：<sec:form-login />だけを定義すると、Spring Security提供のデフォルトログイン画面に遷移
		default-target-url属性を指定すると、ログインのリダイレクト先URLを指定可能。（省略時は「/」）
		login-page属性にパスを指定することで、認証が必要なリソースにアクセスした際、未認証ならこのURLにリダイレクトされる
		authentication-failure-url属性は認証エラー時のリダイレクト先URL
		username-parameter属性はフォームのusername変数を指定できる
		password-parameter属性はフォームのpassword変数を指定できる
		-->
		<sec:form-login 
			default-target-url="/" 
			login-page="/login" 
			username-parameter="loginId"
			password-parameter="password"
			authentication-failure-url="/login?error"/>
  		<!-- ログアウト設定 -->
  		<!-- 
  		logout-success-url： ログアウト成功時のリダイレクト先URL
  		invalidate-session： TRUE⇒サーバー側のセッション破棄
  		delete-cookies="JSESSIONID": クライアント側のクッキーを削除（これをしないとログアウト時に無効なセッションアクセスとなってしまう）
  		 -->
		<sec:logout 
			logout-url="/logout" 
			logout-success-url="/login?logout=true" 
			invalidate-session="true"
			delete-cookies="JSESSIONID" />
		<sec:access-denied-handler ref="accessDeniedHandler" />

		<!-- セッション管理機能 -->
		<!-- 
		max-sessions： 1ユーザーにつき、1セッションのみ許可する
		error-if-maximum-exceeded: 最大セッション数を超えた場合にログインを拒否するかどうか（true: 新しいログインを拒否/ false: 古いセッションを破棄して新規ログインを許可）
		session-registry-ref: セッション管理に使うSessionRegistryのBeanを参照（現在のセッションを把握したり作成したり破棄したり）
		invalid-session-url="/session-invalid": 無効なセッションでアクセスされた場合のリダイレクトパス
		 -->
	 	<sec:session-management invalid-session-url="/session-invalid">
			<sec:concurrency-control 
			max-sessions="1"
			error-if-maximum-exceeded="true"
			session-registry-ref="sessionRegistry" />
		</sec:session-management>
	</sec:http>

	<!-- 認証プロバイダーの設定 -->
	<sec:authentication-manager>
		<!-- 認証処理は下記のBeanを呼び出すという設定（実際のBeanはコンポーネントスキャンにて登録されている） -->
		<sec:authentication-provider user-service-ref="userDetailsService">
			 <sec:password-encoder ref="passwordEncoder" />
		</sec:authentication-provider>
	</sec:authentication-manager>
</beans>
